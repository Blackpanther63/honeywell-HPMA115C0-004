#include <hpma115C0.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h> // Include the I2C LCD library

// Declare variables to store particle data
uint32_t pm1_0, pm2_5, pm4_0, pm10; // Must be uint32_t
uint32_t last_pm1_0 = 0, last_pm2_5 = 0, last_pm4_0 = 0, last_pm10 = 0; // Fallback values

// Create sensor object on Serial1
HPMA115C0 hpma(Serial1);

// Initialize I2C LCD (address 0x27 or 0x3F based on your I2C module)
LiquidCrystal_I2C lcd(0x27, 16, 2); // Adjust the I2C address (0x27 or 0x3F) as per your display

// Pin for buzzer
const int buzzerPin = 8;

void setup() {
  Serial.begin(9600);        // Initialize serial monitor
  Serial1.begin(9600);       // Initialize UART communication with sensor
  delay(5000);               // Wait for sensor to stabilize
  Serial.println("Initializing Dust Sensor...");

  // Initialize the sensor
  hpma.Init();
  hpma.StartParticleMeasurement();
  Serial.println("Sensor initialized successfully.");

  // Initialize the I2C LCD
  lcd.init();
  lcd.backlight();
  lcd.print("Dust Sensor Init");
  delay(2000);
  lcd.clear();

  // Initialize buzzer pin
  pinMode(buzzerPin, OUTPUT);
  digitalWrite(buzzerPin, LOW); // Turn off buzzer initially
}

void loop() {
  pm1_0 = pm2_5 = pm4_0 = pm10 = 0; // Reset values before reading

  // Retry mechanism
  bool readSuccess = false;
  for (int attempt = 0; attempt < 3; attempt++) { // Retry up to 3 times
    if (hpma.ReadParticleMeasurement(&pm1_0, &pm2_5, &pm4_0, &pm10)) {
      readSuccess = true;
      break; // Exit loop if read is successful
    } else {
      Serial.println("Failed to read from dust sensor. Retrying...");
      delay(1000); // Delay before retrying
    }
  }

  // Handle success or fallback
  if (readSuccess) {
    // Update last valid readings
    last_pm1_0 = pm1_0;
    last_pm2_5 = pm2_5;
    last_pm4_0 = pm4_0;
    last_pm10 = pm10;
    Serial.println("Read successful!");
  } else {
    // Use last valid readings if sensor fails
    pm1_0 = last_pm1_0;
    pm2_5 = last_pm2_5;
    pm4_0 = last_pm4_0;
    pm10 = last_pm10;
    Serial.println("Error: Failed to read from dust sensor after multiple attempts. Using last valid readings.");
  }

  // Print particle data on Serial Monitor
  Serial.println("PM1.0: " + String(pm1_0) + " ug/m3");
  Serial.println("PM2.5: " + String(pm2_5) + " ug/m3");
  Serial.println("PM4.0: " + String(pm4_0) + " ug/m3");
  Serial.println("PM10: " + String(pm10) + " ug/m3");
  Serial.println(); // Blank line for readability

  // Clear LCD and print particle data on I2C LCD display
  lcd.clear();
  lcd.setCursor(0, 0); // Line 1
  lcd.print("P1:" + String(pm1_0) + " P2.5:" + String(pm2_5));
  
  lcd.setCursor(0, 1); // Line 2
  lcd.print("P4:" + String(pm4_0) + " P10:" + String(pm10));

  // Check if PM2.5 is greater than 5 and trigger buzzer if true
  if (pm2_5 > 5) {
    Serial.println("Warning: PM2.5 is above 5! Activating buzzer.");
    digitalWrite(buzzerPin, HIGH); // Turn on the buzzer
 444444444444444444444444444   delay(1000); // Buzzer beeps for 1 second
    digitalWrite(buzzerPin, LOW); // Turn off the buzzer
  }

  delay(3000); // Wait before the next reading
}
